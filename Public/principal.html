<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>POMOTASK</title>
  <link rel="stylesheet" href="estilos_principal.css" />
</head>
<body>
  <header class="encabezado">
    <h1><span class="pomo">POMO</span><span class="task">TASK</span></h1>
    <div id="bienvenida">Bienvenido</div>
    <button id="cerrarSesion">Salir</button>
  </header>

  <main class="contenido">
    <section class="formulario">
      <h2>A√±adir tarea:</h2>
      <form id="formTarea">
        <input type="text" id="titulo" placeholder="T√≠tulo" required />
        <input type="date" id="fecha" required />
        <textarea id="descripcion" placeholder="Descripci√≥n" required></textarea>
        <button type="submit">Guardar</button>
      </form>
    </section>

    <section id="pomodoro">
      <h3>Pomodoro</h3>
      <div class="tiempo" id="tiempo">25:00</div>
      <div id="fasePomodoro" style="margin-top: 0.5rem; font-weight: bold; font-size: 1rem; color: #555;">üß† Enfocado</div>
      <button id="comenzar">Comenzar</button>
      <button id="saltar">Saltar</button>
    </section>
  </main>

  <section class="tareas">
    <h2>Tareas</h2>
    <ul id="listaTareas"></ul>
  </section>

  <!-- Audios -->
  <audio id="sonidoPomodoro" src="Assets/pomodoro.wav" preload="auto"></audio>
  <audio id="sonidoDescanso" src="Assets/descanso.wav" preload="auto"></audio>

  <script>
    const correo = localStorage.getItem('correoUsuario');
    if (!correo) window.location.href = './index.html';

    const bienvenida = document.getElementById('bienvenida');
    const listaTareas = document.getElementById('listaTareas');
    const formTarea = document.getElementById('formTarea');

    // Pomodoro
    const tiempo = document.getElementById('tiempo');
    const btnComenzar = document.getElementById('comenzar');
    const btnSaltar = document.getElementById('saltar');
    const fasePomodoro = document.getElementById('fasePomodoro');

    const sonidoPomodoro = document.getElementById('sonidoPomodoro');
    const sonidoDescanso = document.getElementById('sonidoDescanso');

    // Ajustar volumen a 0.3 (30%)
    sonidoPomodoro.volume = 0.3;
    sonidoDescanso.volume = 0.3;

    let minutos = 25;
    let segundos = 0;
    let intervalo = null;
    let estado = 'trabajo'; // trabajo, descansoBreve, descansoLargo
    let ciclosCompletados = 0;
    let pausado = true;

    function actualizarTiempo() {
      tiempo.textContent = `${String(minutos).padStart(2, '0')}:${String(segundos).padStart(2, '0')}`;
    }

    function actualizarFase() {
      if (estado === 'trabajo') {
        fasePomodoro.textContent = 'üß† Enfocado';
        fasePomodoro.style.color = '#ff623d';
      } else if (estado === 'descansoBreve') {
        fasePomodoro.textContent = '‚òï Descanso breve';
        fasePomodoro.style.color = '#3c91e6';
      } else {
        fasePomodoro.textContent = 'üå¥ Descanso largo';
        fasePomodoro.style.color = '#2e7d32';
      }
    }

    function reproducirSonido() {
      if (estado === 'trabajo') {
        sonidoPomodoro.currentTime = 0;
        return sonidoPomodoro.play();
      } else {
        sonidoDescanso.currentTime = 0;
        return sonidoDescanso.play();
      }
    }

    function cambiarEstado() {
      if (estado === 'trabajo') {
        ciclosCompletados++;
        if (ciclosCompletados % 4 === 0) {
          estado = 'descansoLargo';
          minutos = 15;
        } else {
          estado = 'descansoBreve';
          minutos = 5;
        }
        segundos = 0;
        reproducirSonido();
      } else {
        estado = 'trabajo';
        minutos = 25;
        segundos = 0;
        reproducirSonido();
      }
      actualizarFase();
      actualizarTiempo();
    }

    function tick() {
      if (!pausado) {
        if (segundos === 0) {
          if (minutos === 0) {
            cambiarEstado();
          } else {
            minutos--;
            segundos = 59;
          }
        } else {
          segundos--;
        }
        actualizarTiempo();
      }
    }

    btnComenzar.addEventListener('click', () => {
      if (pausado) {
        pausado = false;
        btnComenzar.textContent = 'Pausar';
        if (!intervalo) {
          intervalo = setInterval(tick, 1000);
        }
        const playPromise = reproducirSonido();
        if (playPromise !== undefined) {
          playPromise.catch(err => console.warn("Sonido bloqueado o fall√≥:", err));
        }
      } else {
        pausado = true;
        btnComenzar.textContent = 'Comenzar';
      }
    });

    btnSaltar.addEventListener('click', () => {
      cambiarEstado();
      pausado = false;
      btnComenzar.textContent = 'Pausar';

      if (!intervalo) {
        intervalo = setInterval(tick, 1000);
      }
    });

    actualizarFase();
    actualizarTiempo();

    // --- C√≥digo tareas igual que el que tienes ---
    async function cargarDatos() {
      const res = await fetch(`/usuario?correo=${correo}`);
      const data = await res.json();
      bienvenida.textContent = `Bienvenido ${data.nombre} ${data.apellido}`;
      listaTareas.innerHTML = '';
      data.tareas.forEach(tarea => {
        const item = document.createElement('li');
        item.setAttribute('draggable', 'true');
        item.dataset.id = tarea.id;

        const hoy = new Date();
        const fechaTarea = new Date(tarea.fecha);
        const vencida = fechaTarea < hoy && !tarea.realizado;

        let contenidoHTML = `
          <strong style="color: ${vencida ? 'red' : 'inherit'}">${tarea.fecha}</strong> 
          - <strong>${tarea.titulo}</strong>: ${tarea.descripcion}
          <br />
          Estado: ${tarea.realizado ? '‚úÖ Realizada' : vencida ? 'üõë Tarea vencida' :'‚è≥ Pendiente'}
          <br />
          Destacada: ${tarea.destacado ? '‚≠ê S√≠' : 'No'}<br />
        `;

        if (!vencida) {
          contenidoHTML += `
            <button class="btn-realizar">Marcar como realizada</button>
            <button class="btn-destacar">${tarea.destacado ? 'Quitar destacado' : 'Destacar'}</button>
            <button class="btn-eliminar">Eliminar</button>
          `;
        } else {
          contenidoHTML += `<button class="btn-eliminar">Eliminar</button>`;
        }

        contenidoHTML += `<hr />`;
        item.innerHTML = contenidoHTML;
        listaTareas.appendChild(item);

        if (!vencida) {
          item.querySelector('.btn-realizar').addEventListener('click', () => marcarRealizada(tarea.id));
          item.querySelector('.btn-destacar').addEventListener('click', () => destacar(tarea.id, tarea.destacado));
        }
        item.querySelector('.btn-eliminar').addEventListener('click', () => eliminarTarea(tarea.id));
      });
    }

    async function marcarRealizada(id) {
      await fetch('/tarea/realizada', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ correo, id })
      });
      cargarDatos();
    }

    async function destacar(id, estadoActual) {
      await fetch('/tarea/destacar', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ correo, id, destacado: !estadoActual })
      });
      cargarDatos();
    }

    async function eliminarTarea(id) {
      await fetch('/tarea', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ correo, id })
      });
      cargarDatos();
    }

    formTarea.addEventListener('submit', async (e) => {
      e.preventDefault();
      const titulo = document.getElementById('titulo').value;
      const descripcion = document.getElementById('descripcion').value;
      const fecha = document.getElementById('fecha').value;
      await fetch('/tarea', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ correo, titulo, descripcion, fecha })
      });
      formTarea.reset();
      cargarDatos();
    });

    document.getElementById('cerrarSesion').addEventListener('click', () => {
      localStorage.removeItem('correoUsuario');
      window.location.href = './index.html';
    });

    cargarDatos();
  </script>
</body>
</html>
